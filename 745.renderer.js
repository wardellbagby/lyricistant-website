(()=>{"use strict";var e,t,i,r,n={3847:(e,t,i)=>{var r=i(4375);const n=(0,r.Ud)(self);var s=i(7582),o=i(1370),l=i(211),a=i(5709),d=i(1679),h=i(8975);let c=new l.xQ;c.pipe((0,a.U)((e=>g(...e))),(0,d.j)(25)).subscribe((e=>{u(e)}));const g=(e,t,...i)=>{const r=o.ou.local().toFormat("yyyy-MM-dd hh:mm.u"),n=`${t} ${i.map((e=>JSON.stringify(e))).join(" ")}`;return(0,h.sprintf)("[%(date)s] [%(level)s] %(text)s\n",{date:r,level:e,text:n})},f=()=>{var e;return JSON.parse(null!==(e=sessionStorage.getItem("logs"))&&void 0!==e?e:"[]")},u=e=>{const t=f();t.push(...e),sessionStorage.setItem("logs",JSON.stringify(t))},v=new class{debug(e,...t){console.debug(e,...t),c.next(["debug",e,t])}error(e,...t){console.error(e,...t),c.next(["error",e,t])}verbose(e,...t){console.log(e,...t),c.next(["verbose",e,t])}warn(e,...t){console.warn(e,...t),c.next(["warn",e,t])}info(e,...t){console.info(e,...t),c.next(["info",e,t])}getPrintedLogs(){return(0,s.mG)(this,void 0,void 0,(function*(){c.complete();const e=f();return c=new l.xQ,e}))}};class m{constructor(){this.listeners=new Map}addListener(e,t){const i=this.getListeners(e);i.push(t),this.listeners.set(e,i)}removeListener(e,t){const i=this.getListeners(e);i.splice(i.indexOf(t),1),this.listeners.set(e,i)}getListeners(e){var t;return[...null!==(t=this.listeners.get(e))&&void 0!==t?t:[]]}}const p=e=>e instanceof Error,y=new m,_=new m,S=new Map;new class{send(e,...t){v.info("Sending data to platform",{channel:e,args:t}),((e,t)=>{t.forEach((e=>{p(e)&&v.error(e.message,e)})),e.forEach((e=>e(...t)))})(_.getListeners(e),t)}on(e,t){var i;return v.info("Registering renderer listener",{channel:e}),y.addListener(e,t),null===(i=S.get(e))||void 0===i||i.forEach((e=>e())),this}removeListener(e,t){return v.info("Removing renderer listener",{channel:e}),y.removeListener(e,t),this}};class L{constructor(e){this.logger=e,this.listeners=new m,this.rendererListenerSetListeners=new Map,this.receive=(e,t)=>{this.listeners.getListeners(e).forEach((e=>{Promise.resolve(e(...t)).catch((e=>{throw this.logger.error("Uncaught exception in listener",e),e}))}))},this.onRendererListenerSet=e=>{var t;(null!==(t=this.rendererListenerSetListeners.get(e))&&void 0!==t?t:[]).forEach((e=>e()))},this.addRendererListenerSetListener=(e,t)=>{var i;const r=null!==(i=this.rendererListenerSetListeners.get(e))&&void 0!==i?i:[];r.push(t),this.rendererListenerSetListeners.set(e,r)}}on(e,t){return this.listeners.addListener(e,t),this}removeListener(e,t){return this.listeners.removeListener(e,t),this}send(e,...t){this.logger.info("Sending data to renderer",{channel:e,args:t}),n.receive(e,t)}static get[Symbol.for("___CTOR_ARGS___")](){return["Logger"]}}class D{constructor(e){this.clock=e,this.messages=[],this.debug=(e,...t)=>{console.debug(e,...t),this.messages.push(this.formatMessage("debug",e,...t)),this.maybeAddToCache()},this.error=(e,...t)=>{console.error(e,...t),this.messages.push(this.formatMessage("error",e,...t)),this.maybeAddToCache()},this.info=(e,...t)=>{console.info(e,...t),this.messages.push(this.formatMessage("info",e,...t)),this.maybeAddToCache()},this.verbose=(e,...t)=>{console.debug(e,...t),this.messages.push(this.formatMessage("verbose",e,...t)),this.maybeAddToCache()},this.warn=(e,...t)=>{console.warn(e,...t),this.messages.push(this.formatMessage("warn",e,...t)),this.maybeAddToCache()},this.getPrintedLogs=()=>this.flush().then((()=>this.getAllLogs())),this.flush=()=>this.maybeAddToCache(!0),this.getAllLogs=()=>n.getSessionStorage().then((e=>(0,s.mG)(this,void 0,void 0,(function*(){var t;return null!==(t=JSON.parse(yield e.getItem("logs")))&&void 0!==t?t:[]})))),this.maybeAddToCache=(e=!1)=>e||this.messages.length>25?this.getAllLogs().then((e=>(0,s.mG)(this,void 0,void 0,(function*(){return e.push(...this.messages),this.messages=[],n.getSessionStorage().then((t=>t.setItem("logs",JSON.stringify(e))))})))):Promise.resolve(),this.formatMessage=(e,t,...i)=>{const r=this.clock.now().formatIso(),n=`${t} ${i.map((e=>JSON.stringify(e))).join(" ")}`;return(0,h.sprintf)("[%(date)s] [%(level)s] %(text)s",{date:r,level:e,text:n})}}static get[Symbol.for("___CTOR_ARGS___")](){return["Clock"]}}class F{constructor(){this.prefsKey="lyricistant_preferences",this.setPreferences=e=>(0,s.mG)(this,void 0,void 0,(function*(){(yield n.getLocalStorage()).setItem(this.prefsKey,JSON.stringify(e))})),this.getPreferences=()=>(0,s.mG)(this,void 0,void 0,(function*(){const e=yield n.getLocalStorage(),t=yield e.getItem(this.prefsKey);return t?JSON.parse(t):void 0}))}}class b{constructor(){this.getRecentFiles=()=>[],this.setRecentFiles=()=>{}}}class E{constructor(){this.set=(e,t)=>{n.getLocalStorage().then((i=>i.setItem(e,JSON.stringify(t))))},this.get=e=>(0,s.mG)(this,void 0,void 0,(function*(){if(!(yield this.exists(e)))return;const t=yield n.getLocalStorage();return JSON.parse(yield t.getItem(e))})),this.exists=e=>(0,s.mG)(this,void 0,void 0,(function*(){const t=yield n.getLocalStorage();return!!(yield t.getItem(e))})),this.delete=e=>{n.getLocalStorage().then((t=>t.removeItem(e)))}}}class T{constructor(){this.handles=new Map,this.openFile=e=>(0,s.mG)(this,void 0,void 0,(function*(){if(e)return this.handles.set(e.metadata.path,e.extras.handle),e;const t=yield n.getFileSystem(),i=yield t.openFile();if(!i)return;const{path:r,data:s,handle:o}=i;return this.handles.set(r,o),{data:s,type:"",metadata:{path:r}}})),this.saveFile=(e,t,i)=>(0,s.mG)(this,void 0,void 0,(function*(){var r,s;const{handle:o,cancelled:l}=yield(yield n.getFileSystem()).saveFile(e,t,this.handles.get(i));if(l)return null;const a=null!==(s=null!==(r=null==o?void 0:o.name)&&void 0!==r?r:i)&&void 0!==s?s:t;return o&&this.handles.set(a,o),{path:a}}))}}var A;!function(e){e[e.Light=0]="Light",e[e.Dark=1]="Dark"}(A||(A={}));class w{constructor(){this.onChange=e=>{O(e)}}}const O=e=>{self.matchMedia?(self.matchMedia("(prefers-color-scheme: dark)").matches?e(A.Dark):e(A.Light),window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",(t=>{e(t.matches?A.Dark:A.Light)}))):e(A.Dark)},R=new TextDecoder,C=new TextEncoder;class x{constructor(){this.bufferToString=e=>R.decode(e),this.stringToBuffer=e=>C.encode(e)}}class G{constructor(){this.elapsed=()=>performance.now()}}const I=["No","Yes"],M=e=>(0,s.mG)(void 0,void 0,void 0,(function*(){return new Promise((t=>{const i=r=>{e.removeListener("editor-text",i),t(r)};e.on("editor-text",i),e.send("request-editor-text")}))})),P=(e,...t)=>(0,s.mG)(void 0,void 0,void 0,(function*(){return new Promise((i=>{const r=(...t)=>{e.removeListener("dialog-interaction",r),e.removeListener("dialog-closed",n),i(t)},n=()=>{e.removeListener("dialog-interaction",r),e.removeListener("dialog-closed",n)};e.on("dialog-interaction",r),e.on("dialog-closed",n),e.send("show-dialog",...t)}))}));class N{constructor(e,t,i,r,n,o){this.rendererDelegate=e,this.fileManager=t,this.appData=i,this.fileHistory=r,this.times=n,this.logger=o,this.lastFileSaveMs=null,this.hasPromptedUnsavedDataRecovery=!1,this.register=()=>{this.fileManager.setInitialFileLoadedListener(this.checkForUnsavedData),this.rendererDelegate.on("editor-idle",this.onEditorIdle),this.fileManager.addOnFileChangedListener((()=>{this.hasPromptedUnsavedDataRecovery&&this.appData.delete(N.UNSAVED_LYRICS_KEY)}))},this.checkForUnsavedData=()=>(0,s.mG)(this,void 0,void 0,(function*(){if(this.logger.verbose("Checking for unsaved data..."),(yield this.appData.exists(N.UNSAVED_LYRICS_KEY))&&(yield this.fileHistory.isNonEmptyHistory(yield this.getUnsavedData()))){this.logger.verbose("Unsaved data found.");const[e,t]=yield P(this.rendererDelegate,{type:"alert",tag:N.RECOVER_UNSAVED_LYRICS_TAG,title:"Recover unsaved lyrics",message:"Unsaved lyrics found. Would you like to recover them?",buttons:I});yield this.onDialogClicked(e,t.selectedButton)}else this.hasPromptedUnsavedDataRecovery=!0,this.startAutomaticFileSaver()})),this.onDialogClicked=(e,t)=>(0,s.mG)(this,void 0,void 0,(function*(){e===N.RECOVER_UNSAVED_LYRICS_TAG&&("Yes"===t&&(yield this.fileHistory.deserialize(yield this.getUnsavedData()),this.rendererDelegate.send("file-opened",void 0,this.fileHistory.getParsedHistory(),!1)),this.hasPromptedUnsavedDataRecovery=!0,this.startAutomaticFileSaver())})),this.onEditorIdle=e=>(0,s.mG)(this,void 0,void 0,(function*(){this.canPerformFileSave()?(this.logger.verbose("Editor is idle; saving unsaved data"),yield this.performFileSave(e)):this.logger.verbose("Editor is idle but unsaved data save was too recent. Skipping.")})),this.startAutomaticFileSaver=()=>{setTimeout(this.onAutomaticFileSaveTriggered,N.AUTOMATIC_FILE_SAVE_MS)},this.onAutomaticFileSaveTriggered=()=>{const e=t=>(0,s.mG)(this,void 0,void 0,(function*(){this.rendererDelegate.removeListener("editor-text",e),yield this.performFileSave(t),setTimeout(this.onAutomaticFileSaveTriggered,N.AUTOMATIC_FILE_SAVE_MS)}));this.rendererDelegate.on("editor-text",e),this.rendererDelegate.send("request-editor-text")},this.performFileSave=e=>(0,s.mG)(this,void 0,void 0,(function*(){this.fileHistory.add(e),yield this.appData.set(N.UNSAVED_LYRICS_KEY,yield this.fileHistory.serialize()),this.lastFileSaveMs=this.times.elapsed()})),this.canPerformFileSave=()=>this.hasPromptedUnsavedDataRecovery||null==this.lastFileSaveMs||this.times.elapsed()-this.lastFileSaveMs>=N.MINIMUM_FILE_SAVE_ELAPSED_TIME_MS,this.getUnsavedData=()=>this.appData.get(N.UNSAVED_LYRICS_KEY)}static get[Symbol.for("___CTOR_ARGS___")](){return["RendererDelegate","FileManager","AppData","FileHistory","Times","Logger"]}}N.UNSAVED_LYRICS_KEY="unsaved-lyrics-key",N.RECOVER_UNSAVED_LYRICS_TAG="unsaved-data-manager-recover-lyrics",N.MINIMUM_FILE_SAVE_ELAPSED_TIME_MS=3e4,N.AUTOMATIC_FILE_SAVE_MS=3e5;class H{constructor(e,t){this.appData=e,this.logger=t,this.register=()=>{addEventListener("unload",(()=>{var e,t;this.logger.info("User is leaving page. Deleting unsaved lyrics."),null===(t=(e=this.logger).flush)||void 0===t||t.call(e),this.appData.delete(N.UNSAVED_LYRICS_KEY)}))}}static get[Symbol.for("___CTOR_ARGS___")](){return["AppData","PlatformLogger"]}}class k extends Error{constructor(e){super(e),this.name="CancelError"}static get[Symbol.for("___CTOR_ARGS___")](){return["string"]}}class U{constructor(){this.isCancelled=!1,this.listeners=[],this.addOnCancelListener=e=>{this.isCancelled?e():this.listeners.push(e)},this.cancel=()=>{this.isCancelled=!0,this.listeners.forEach((e=>e())),this.listeners=[]}}}class j{constructor(){this.signal=new U,this.cancel=()=>this.signal.cancel()}}const V=(e,t)=>{if(!(e&&e instanceof Promise))throw new Error("Invalid promise");return new Promise(((i,r)=>(0,s.mG)(void 0,void 0,void 0,(function*(){t.addOnCancelListener((()=>r(new k("Promise cancelled")))),e.then(i,r).catch(r)}))))};var W,K,Y,B,J;!function(e){e[e.Light=0]="Light",e[e.Dark=1]="Dark",e[e.System=2]="System"}(W||(W={})),function(e){e[e.Roboto_Mono=0]="Roboto_Mono",e[e.Roboto=1]="Roboto"}(K||(K={})),function(e){e[e.Offline=0]="Offline",e[e.Datamuse=1]="Datamuse"}(Y||(Y={})),function(e){e[e.Always_Ask=0]="Always_Ask",e[e.Lyricistant_Lyrics=1]="Lyricistant_Lyrics",e[e.Plain_Text=2]="Plain_Text"}(B||(B={})),function(e){e[e.Toggleable=0]="Toggleable",e[e.Always_Show=1]="Always_Show"}(J||(J={}));const z=e=>(0,s.mG)(void 0,void 0,void 0,(function*(){var t;const i=yield e.getPreferences();return Object.assign(Object.assign({textSize:16,colorScheme:W.System,rhymeSource:Y.Datamuse,font:K.Roboto,defaultFileType:B.Always_Ask,detailPaneVisibility:J.Always_Show},yield null===(t=e.getDefaultPreferences)||void 0===t?void 0:t.call(e)),i)}));class ${constructor(e,t,i,r,n,o,l,a){this.rendererDelegate=e,this.files=t,this.buffers=i,this.recentFiles=r,this.fileHandlers=n,this.fileDataExtensions=o,this.preferences=l,this.logger=a,this.initialFile=null,this.currentFile=null,this.fileChangedListeners=[],this.initialFileLoadedListener=void 0,this.isRendererReady=!1,this.addOnFileChangedListener=e=>{this.fileChangedListeners.push(e)},this.setInitialFileLoadedListener=e=>{this.initialFileLoadedListener=e},this.onNewFile=()=>{const e=t=>(0,s.mG)(this,void 0,void 0,(function*(){this.rendererDelegate.removeListener("is-file-modified",e),t?yield this.onPromptSaveFileForNew():this.createNewFile()}));this.rendererDelegate.on("is-file-modified",e),this.rendererDelegate.send("check-file-modified")},this.onOpenFile=e=>(0,s.mG)(this,void 0,void 0,(function*(){if(!this.isRendererReady&&e)return this.logger.verbose("Received a file before renderer ready; delaying open",e.metadata),void(this.initialFile=e);const t=i=>(0,s.mG)(this,void 0,void 0,(function*(){this.rendererDelegate.removeListener("is-file-modified",t),i?yield this.onPromptSaveFileForOpen(e):yield this.openFile(e)}));this.rendererDelegate.on("is-file-modified",t),this.rendererDelegate.send("check-file-modified")})),this.onSaveFile=e=>{this.showLoadingDialog("save");const t=i=>(0,s.mG)(this,void 0,void 0,(function*(){var r;this.rendererDelegate.removeListener("editor-text",t);let n=null===(r=this.currentFile)||void 0===r?void 0:r.path;e&&(n=null),yield this.saveFileActual(i,n)}));this.rendererDelegate.on("editor-text",t),this.rendererDelegate.send("request-editor-text")},this.openFile=e=>(0,s.mG)(this,void 0,void 0,(function*(){const t=this.showLoadingDialog("open",!0);try{const i=yield V(this.files.openFile(e),t);i&&(yield this.openFileActual(i))}catch(e){e instanceof k||this.logger.error("Error opening file.",e),this.rendererDelegate.send("file-opened",e,void 0,!0)}finally{this.rendererDelegate.send("close-dialog",$.OPEN_FILE_DIALOG_TAG)}})),this.onRendererReady=()=>(0,s.mG)(this,void 0,void 0,(function*(){var e;this.isRendererReady=!0,this.createNewFile(),this.initialFile&&(this.logger.verbose("Renderer ready; opening delayed file",this.initialFile.metadata),yield this.onOpenFile(this.initialFile),this.initialFile=null),null===(e=this.initialFileLoadedListener)||void 0===e||e.call(this)})),this.onRendererSaveFile=e=>(0,s.mG)(this,void 0,void 0,(function*(){var t;this.showLoadingDialog("save"),yield this.saveFileActual(e,null===(t=this.currentFile)||void 0===t?void 0:t.path)})),this.saveFileActual=(e,t)=>(0,s.mG)(this,void 0,void 0,(function*(){var i,r;try{this.logger.debug("Saving file with lyrics",{path:t,lyrics:e}),this.fileDataExtensions.forEach((t=>{var i;return null===(i=t.onBeforeSerialization)||void 0===i?void 0:i.call(t,e)}));const n={};for(const e of this.fileDataExtensions)n[e.key]=this.buffers.stringToBuffer(JSON.stringify(yield e.serialize()));const s=t?null===(i=this.currentFile)||void 0===i?void 0:i.handler:yield this.getDefaultFileHandler(),o=yield s.create({extensions:n,lyrics:e}),l=this.showLoadingDialog("save",!0),a=yield V(this.files.saveFile(o,`Lyrics.${s.extension}`,t),l);if(a){this.showLoadingDialog("save");const t=null!==(r=a.name)&&void 0!==r?r:a.path;this.currentFile={path:a.path,handler:s},this.rendererDelegate.send("file-opened",void 0,e,!0),this.addRecentFile(a.path),this.fileChangedListeners.forEach((e=>e(t,this.recentFiles.getRecentFiles()))),this.rendererDelegate.send("file-save-ended",null,t)}else this.rendererDelegate.send("file-save-ended",null,null)}catch(e){this.logger.error("Error saving file",e)}finally{this.rendererDelegate.send("close-dialog",$.SAVE_FILE_DIALOG_TAG)}})),this.openFileActual=e=>(0,s.mG)(this,void 0,void 0,(function*(){var t,i;this.showLoadingDialog("open");const{handler:r,fileData:n}=yield this.createFileData(e);this.currentFile={path:e.metadata.path,handler:r};for(const e of this.fileDataExtensions){const i=this.buffers.bufferToString(null===(t=n.extensions)||void 0===t?void 0:t[e.key]);(null==i?void 0:i.length)>0?yield e.deserialize(JSON.parse(i)):e.reset()}this.rendererDelegate.send("file-opened",void 0,null!==(i=null==n?void 0:n.lyrics)&&void 0!==i?i:"",!0),this.addRecentFile(this.currentFile.path);const s=this.recentFiles.getRecentFiles();this.fileChangedListeners.forEach((t=>{var i;return t(null!==(i=e.metadata.name)&&void 0!==i?i:e.metadata.path,s)}))})),this.createNewFile=()=>{this.currentFile=null,this.rendererDelegate.send("new-file-created"),this.fileDataExtensions.forEach((e=>e.reset())),this.fileChangedListeners.forEach((e=>e(null,this.recentFiles.getRecentFiles())))},this.onPromptSaveFileForNew=()=>(0,s.mG)(this,void 0,void 0,(function*(){const[e,{selectedButton:t}]=yield P(this.rendererDelegate,{tag:$.CONFIRM_NEW_FILE_TAG,type:"alert",title:"Discard unsaved changes?",message:"Your changes haven't been saved. Are you sure you want to create a new file?",buttons:["Cancel","Create new file"]});e===$.CONFIRM_NEW_FILE_TAG&&("Create new file"===t?this.createNewFile():this.logger.debug("User selected to not create a new file."))})),this.onPromptSaveFileForOpen=e=>(0,s.mG)(this,void 0,void 0,(function*(){const[t,{selectedButton:i}]=yield P(this.rendererDelegate,{tag:$.CONFIRM_OPEN_FILE_TAG,type:"alert",title:"Discard unsaved changes?",message:"Your changes haven't been saved. Are you sure you want to open a different file?",buttons:["Cancel","Open file"]});t===$.CONFIRM_OPEN_FILE_TAG&&("Open file"===i?yield this.openFile(e):this.logger.debug("User selected to not open file",null==e?void 0:e.metadata))})),this.addRecentFile=e=>{this.logger.debug("Attempting to add recent file",e);let t=this.recentFiles.getRecentFiles();t.unshift(e),t=Array.from(new Set(t)),t.length>10&&t.pop(),this.recentFiles.setRecentFiles(t)},this.createFileData=e=>(0,s.mG)(this,void 0,void 0,(function*(){const t=this.fileHandlers.find((t=>t.canHandle(e)));return{handler:t,fileData:yield null==t?void 0:t.load(e)}})),this.showLoadingDialog=(e,t=!1)=>{const i="open"===e?$.OPEN_FILE_DIALOG_TAG:$.SAVE_FILE_DIALOG_TAG;if(this.rendererDelegate.send("show-dialog",{tag:i,type:"fullscreen",message:("open"===e?"Opening":"Saving")+" file",progress:"indeterminate",cancelable:t}),!0===t){const e=new j,t=r=>{r===i&&(this.rendererDelegate.removeListener("dialog-closed",t),e.cancel())};return this.rendererDelegate.on("dialog-closed",t),e.signal}},this.promptFileHandlerSelection=()=>(0,s.mG)(this,void 0,void 0,(function*(){var e;const t=this.fileHandlers.find((e=>"lyrics"===e.extension)),i=this.fileHandlers.find((e=>"txt"===e.extension)),r="Plain text (.txt)",n="Never ask again",[s,o]=yield P(this.rendererDelegate,{tag:$.CHOOSE_FILE_HANDLER_TAG,type:"selection",title:"Select file type",checkbox:{label:n},message:"What file type to save as? Text files have wide compatibility, but Lyrics files support all Lyricistant features.",options:["Lyricistant file (.lyrics)",r]});if(s===$.CHOOSE_FILE_HANDLER_TAG){if(null===(e=o.checkboxes)||void 0===e?void 0:e[n]){const e=yield z(this.preferences);yield this.preferences.setPreferences(Object.assign(Object.assign({},e),{defaultFileType:o.selectedOption===r?B.Plain_Text:B.Lyricistant_Lyrics}))}return o.selectedOption===r?i:t}})),this.getDefaultFileHandler=()=>(0,s.mG)(this,void 0,void 0,(function*(){const e=yield z(this.preferences),t=this.fileHandlers.find((e=>"txt"===e.extension)),i=this.fileHandlers.find((e=>"lyrics"===e.extension));switch(e.defaultFileType){case B.Always_Ask:return yield this.promptFileHandlerSelection();case B.Plain_Text:return t;default:return i}}))}register(){this.rendererDelegate.on("ready-for-events",this.onRendererReady),this.rendererDelegate.on("new-file-attempt",this.onNewFile),this.rendererDelegate.on("open-file-attempt",this.onOpenFile),this.rendererDelegate.on("save-file-attempt",this.onRendererSaveFile)}static get[Symbol.for("___CTOR_ARGS___")](){return["RendererDelegate","Files","Buffers","RecentFiles","FileHandlers","FileDataExtensions","Preferences","Logger"]}}$.SAVE_FILE_DIALOG_TAG="save-file",$.OPEN_FILE_DIALOG_TAG="open-file",$.CONFIRM_NEW_FILE_TAG="confirm-new-file",$.CONFIRM_OPEN_FILE_TAG="confirm-open-file",$.CHOOSE_FILE_HANDLER_TAG="choose-file-handler";class Z{constructor(e,t,i){this.rendererDelegate=e,this.systemThemeProvider=t,this.preferences=i,this.onThemeChangedListeners=[],this.addThemeChangedListener=e=>{this.onThemeChangedListeners.push(e)},this.onSavePrefs=e=>(0,s.mG)(this,void 0,void 0,(function*(){e&&(yield this.preferences.setPreferences(e),this.rendererDelegate.send("prefs-updated",e),this.sendThemeUpdate(e))})),this.sendThemeUpdate=e=>{const t=this.normalizeColorScheme(e.colorScheme),i=e.colorScheme===W.System?this.systemPalette:void 0;this.rendererDelegate.send("theme-updated",Object.assign(Object.assign({},e),{colorScheme:t,systemPalette:i})),this.onThemeChangedListeners.forEach((e=>e(t,i)))},this.systemThemeToTheme=e=>e===A.Dark?W.Dark:W.Light}register(){this.rendererDelegate.on("save-prefs",this.onSavePrefs),this.systemThemeProvider.onChange(((e,t)=>(0,s.mG)(this,void 0,void 0,(function*(){this.systemTheme=e,this.systemPalette=t,this.sendThemeUpdate(yield z(this.preferences))})))),this.rendererDelegate.addRendererListenerSetListener("prefs-updated",(()=>(0,s.mG)(this,void 0,void 0,(function*(){this.rendererDelegate.send("prefs-updated",yield z(this.preferences))})))),this.rendererDelegate.addRendererListenerSetListener("theme-updated",(()=>(0,s.mG)(this,void 0,void 0,(function*(){this.sendThemeUpdate(yield z(this.preferences))}))))}normalizeColorScheme(e){return e===W.System?this.systemThemeToTheme(this.systemTheme):e}static get[Symbol.for("___CTOR_ARGS___")](){return["RendererDelegate","SystemThemeProvider","Preferences"]}}class q{constructor(e,t,i,r){this.rendererDelegate=e,this.provideUiConfig=t,this.formatTitle=i,this.fileManager=r}register(){this.rendererDelegate.addRendererListenerSetListener("ui-config",(()=>{this.rendererDelegate.send("ui-config",this.provideUiConfig())})),this.fileManager.addOnFileChangedListener((e=>{this.rendererDelegate.send("app-title-changed",this.formatTitle(e))}))}static get[Symbol.for("___CTOR_ARGS___")](){return["RendererDelegate","UiConfigProvider","TitleFormatter","FileManager"]}}class Q{constructor(e,t,i,r){this.rendererDelegate=e,this.files=t,this.buffers=i,this.logger=r}register(){this.rendererDelegate.on("save-logs",(()=>(0,s.mG)(this,void 0,void 0,(function*(){const e=yield this.logger.getPrintedLogs();yield this.files.saveFile(this.buffers.stringToBuffer(e.join("\n")),"logs.txt")}))))}static get[Symbol.for("___CTOR_ARGS___")](){return["RendererDelegate","Files","Buffers","PlatformLogger"]}}class X{constructor(e,t){this.rendererDelegate=e,this.fileHistory=t,this.getIncrementalHistory=()=>(0,s.mG)(this,void 0,void 0,(function*(){var e;return null!==(e=this.fileHistory.getIncrementalParsedHistory({includeChunks:{base:yield M(this.rendererDelegate)}}))&&void 0!==e?e:[]}))}register(){this.rendererDelegate.on("apply-file-history",(e=>{this.fileHistory.add(e.text),this.rendererDelegate.send("file-opened",void 0,e.text,!1)})),this.rendererDelegate.addRendererListenerSetListener("file-history",(()=>(0,s.mG)(this,void 0,void 0,(function*(){this.rendererDelegate.send("file-history",yield this.getIncrementalHistory())}))))}static get[Symbol.for("___CTOR_ARGS___")](){return["RendererDelegate","FileHistory"]}}class ee{constructor(e,t){this.rendererDelegate=e,this.appData=t,this.register=()=>{this.rendererDelegate.on("ready-for-events",this.onReadyForEvents)},this.onReadyForEvents=e=>(0,s.mG)(this,void 0,void 0,(function*(){e.isDeepLink||(!(yield this.appData.exists(ee.IS_FIRST_LAUNCH_KEY))&&this.rendererDelegate.send("open-about"),this.appData.set(ee.IS_FIRST_LAUNCH_KEY,!1))}))}static get[Symbol.for("___CTOR_ARGS___")](){return["RendererDelegate","AppData"]}}ee.IS_FIRST_LAUNCH_KEY="is-first-launch";const te=(e,t,i)=>({formatLocal:r=>e.toLocaleString(Object.assign(Object.assign({},r),{timeZone:null!=i?i:r.timeZone}),t),formatIso:()=>e.toISO()});class ie{constructor(){this.now=()=>te(o.ou.local()),this.fromIso=e=>te(o.ou.fromISO(e))}}const re=".lyrics";var ne=i(5733),se=i.n(ne),oe=i(4337);const le="lyrics.txt";class ae{constructor(){this.extension="lyrics",this.canHandle=e=>{var t,i;return"application/zip"===e.type||(0,oe.Z)(new Uint8Array(e.data).subarray(0,4),Uint8Array.from([80,75,3,4]))||e.metadata.path.endsWith(re)||(null===(i=null===(t=e.metadata)||void 0===t?void 0:t.name)||void 0===i?void 0:i.endsWith(re))},this.load=e=>(0,s.mG)(this,void 0,void 0,(function*(){const t=new(se());yield t.loadAsync(e.data);const{version:i,createdWith:r}=yield this.readVersion(t);if(!i||i<=0)throw new Error("This file is incompatible with Lyricistant.");if(1===i)return de(t);throw new Error(`This file is not compatible with this version of Lyricistant. Try using version ${r}`)})),this.create=e=>(0,s.mG)(this,void 0,void 0,(function*(){const t=new(se());t.file(le,e.lyrics).file("version.json",JSON.stringify(this.createVersion()));const i=t.folder("extensions");return Object.keys(e.extensions).filter((e=>"lyrics"!==e)).forEach((t=>{var r;i.file(`${t}.dat`,null===(r=e.extensions)||void 0===r?void 0:r[t])})),t.generateAsync({type:"arraybuffer"})})),this.readVersion=e=>(0,s.mG)(this,void 0,void 0,(function*(){return JSON.parse(yield e.file("version.json").async("string"))})),this.createVersion=()=>({version:1,createdWith:"3.3.0"})}}const de=e=>(0,s.mG)(void 0,void 0,void 0,(function*(){var t;const i={lyrics:null!==(t=yield e.file(le).async("string"))&&void 0!==t?t:""},r={},n=e.folder("extensions").filter((()=>!0));for(const e of n)r[e.name.replace("extensions/","").replace(".dat","")]=yield e.async("arraybuffer");return Object.assign({extensions:r},i)}));class he{constructor(e){this.buffers=e,this.extension="txt",this.canHandle=e=>{var t;return"text/plain"===(null==e?void 0:e.type)||(null===(t=e.metadata.name)||void 0===t?void 0:t.endsWith("txt"))||e.metadata.path.endsWith("txt")},this.create=e=>(0,s.mG)(this,void 0,void 0,(function*(){return this.buffers.stringToBuffer(e.lyrics)})),this.load=e=>(0,s.mG)(this,void 0,void 0,(function*(){return{lyrics:this.buffers.bufferToString(e.data)}}))}static get[Symbol.for("___CTOR_ARGS___")](){return["Buffers"]}}const ce=e=>null==e?null:0===e.length?{line:"<< Empty line >>",control:!0}:{line:e,control:!1},ge=e=>{const t=[];let i=null,r=null;const n=()=>{r.sort(((e,t)=>"old"===e.type&&"new"===t.type?-1:"old"===t.type&&"new"===e.type?1:0)),t.push(...r),i=null,r=null};for(const s of e)"context"!==s.type?i?(r.push(s),i=s.type):(r=[s],i=s.type):(null!=r&&n(),t.push(s));return r&&n(),t},fe=o.ou.DATETIME_MED_WITH_SECONDS;class ue{constructor(e,t){this.clock=e,this.logger=t,this.key="history",this.delta=[],this.lastKnownLyrics="",this.onBeforeSerialization=e=>{this.add(e)},this.serialize=()=>(0,s.mG)(this,void 0,void 0,(function*(){return{version:2,data:this.delta}})),this.deserialize=e=>(0,s.mG)(this,void 0,void 0,(function*(){this.lastKnownLyrics="",this.delta=yield this.loadFromSerialized(e),this.lastKnownLyrics=this.getParsedHistory()})),this.reset=()=>{this.lastKnownLyrics="",this.delta=[]},this.isNonEmptyHistory=e=>(0,s.mG)(this,void 0,void 0,(function*(){return(yield this.loadFromSerialized(e)).length>0})),this.add=e=>{if(e.trim()===this.lastKnownLyrics||0===e.trim().length)return;this.logger.verbose("Adding file history",{new:e,old:this.lastKnownLyrics});const t=this.createChanges(this.lastKnownLyrics,e);if(this.delta.push({changes:t,time:this.clock.now().formatIso()}),this.delta.length>ue.MAX_DELTA_SIZE){const e=this.applyChanges("",this.delta[0].changes),t=this.applyChanges(e,this.delta[1].changes),i=this.createChanges("",t);this.delta.splice(0,2,{changes:i,time:this.delta[1].time})}this.lastKnownLyrics=e},this.getIncrementalParsedHistory=e=>{let t="";return this.delta.map((i=>{const r=this.applyChanges(t,i.changes);let n;return n=(null==e?void 0:e.includeChunks)?((e,t)=>{if(!t||0===t.length)return[{lines:[{type:"context",line:"<< No changes >>",control:!0}]}];const i=e.split("\n");return(e=>{const t=[];let i=0;return e.sort(((e,t)=>e.line-t.line)).forEach(((r,n)=>{if(0===n)return void(t[i]=[r]);const s=e[n-1];r.line-s.line<3?t[i].push(r):(i+=1,t[i]=[r])})),t})(t).map((e=>{const t=e[0],r=e[e.length-1],n=((e,t)=>{if(0===t.line)return[];const i=Math.max(t.line-2,0);return e.slice(i,t.line).map((e=>{const t=ce(e);return{type:"context",line:t.line,control:t.control}}))})(i,t),s=((e,t)=>{const i=[],r=e.length-1;if(t.line<r){const n=Math.min(t.line+2,r);i.push(...e.slice(t.line+1,n).map((e=>{const t=ce(e);return{type:"context",line:t.line,control:t.control}})))}return t.line>=r&&i.push({type:"context",line:"<< End of file >>",control:!0}),i})(i,r),o=(l=t.line,a=r.line+1,[...Array(a-l).keys()].map((e=>e+l))).map((t=>{var r,n;const s=ce(i[t]),o=e.filter((e=>e.line===t)),l=ce(((e,t)=>{let i=e;return t.forEach((e=>{i=-1===e.type?null:e.value})),i})(null==s?void 0:s.line,o));return(null==s?void 0:s.line)!==(null==l?void 0:l.line)?!(null==s?void 0:s.line)||(null==s?void 0:s.control)&&(null==l?void 0:l.line)?{type:"new",line:l.line,control:l.control}:!(null==l?void 0:l.line)||(null==l?void 0:l.control)&&(null==s?void 0:s.line)?{type:"old",line:s.line,control:s.control}:[{type:"old",line:s.line,control:s.control},{type:"new",line:l.line,control:l.control}]:{type:"context",line:null!==(r=null==s?void 0:s.line)&&void 0!==r?r:"<< Empty line >>",control:null===(n=null==s?void 0:s.control)||void 0===n||n}})).reduce(((e,t)=>Array.isArray(t)?(e.push(...t),e):(e.push(t),e)),[]);var l,a;return{lines:[...n,...ge(o),...s]}}))})(e.includeChunks.base,this.createChanges(e.includeChunks.base,r)):[],t=r,{time:this.clock.fromIso(i.time).formatLocal(fe),text:r,chunks:n}})).reverse()},this.getParsedHistory=()=>{var e,t,i;if(this.lastKnownLyrics.length>0)return this.lastKnownLyrics;const r=this.getIncrementalParsedHistory();return this.lastKnownLyrics=null!==(i=null===(t=null===(e=r[0])||void 0===e?void 0:e.text)||void 0===t?void 0:t.trim())&&void 0!==i?i:"",this.lastKnownLyrics},this.loadFromSerialized=e=>(0,s.mG)(this,void 0,void 0,(function*(){return yield((e,t,i)=>(0,s.mG)(void 0,void 0,void 0,(function*(){if((null===(r=e)||"object"!=typeof r)&&"function"!=typeof r||"number"!=typeof r.version)return t.warn("Tried to load extension data that didn't conform to the VersionedExtensionData type.",e),i.invalid();var r;const n=null==e?void 0:e.version;if(!n||!(n in i))return t.warn("No handler registered to handle extension data",e),i.invalid();try{return i[n](e.data)}catch(r){return t.warn("Exception when handling extension data",e,r),i.invalid()}})))(e,this.logger,{1:e=>(0,s.mG)(this,void 0,void 0,(function*(){return this.migrateV1ToV2(yield this.loadV1(e))})),2:e=>this.loadV2(e),invalid:()=>[]})})),this.loadV1=e=>(0,s.mG)(this,void 0,void 0,(function*(){if("string"!=typeof e)return this.logger.warn("Invalid history data",e),[];if(0===e.trim().length)return[];const t=JSON.parse(e);return Array.isArray(t)&&t.every((e=>{return!((null!==(t=e)&&"object"==typeof t||"function"==typeof t)&&"string"==typeof t.time&&Array.isArray(t.patches));var t}))?(this.logger.warn("Invalid history data",t),[]):t})),this.loadV2=e=>(0,s.mG)(this,void 0,void 0,(function*(){return Array.isArray(e)&&e.every((e=>{return(null!==(t=e)&&"object"==typeof t||"function"==typeof t)&&"string"==typeof t.time&&Array.isArray(t.changes)&&t.changes.every((e=>(e=>!((null===e||"object"!=typeof e)&&"function"!=typeof e||-1!==e.type&&0!==e.type&&1!==e.type||"number"!=typeof e.line||"string"!=typeof e.value&&void 0!==e.value))(e)));var t}))?e:[]})),this.migrateV1ToV2=e=>(0,s.mG)(this,void 0,void 0,(function*(){let t="";const r=new(0,(yield i.e(27).then(i.t.bind(i,2027,23))).default.diff_match_patch);return e.map((e=>{const i=r.patch_apply(e.patches,t)[0],n=this.createChanges(t,i),s={time:e.time,changes:n};return t=i,s}))})),this.createChanges=(e,t)=>{const i=e.split("\n"),r=t.split("\n"),n=[];let s=0;return i.forEach(((e,t)=>{const i=t+s,o=r.indexOf(e,i);if(o>=0){const e=r.slice(i,o).map(((e,t)=>({type:1,line:i+t,value:e})));n.push(...e),s+=e.length}else i<r.length?n.push({type:0,line:i,value:r[i]}):n.push({type:-1,line:i})})),n.push(...r.slice(i.length+s).map(((e,t)=>({type:1,line:i.length+t+s,value:e})))),n},this.applyChanges=(e,t)=>{const i=e.split("\n");return t.forEach((e=>{1===e.type?e.line<i.length&&null==i[e.line]?i[e.line]=e.value:i.splice(e.line,0,e.value):i[e.line]=0===e.type?e.value:null})),i.filter((e=>"string"==typeof e)).join("\n")}}static get[Symbol.for("___CTOR_ARGS___")](){return["Clock","Logger"]}}ue.MAX_DELTA_SIZE=100;const ve=()=>({showDownload:!0,showOpen:!!Blob&&!!File,showBrowserWarning:!0,promptOnUrlChange:!0}),me=e=>e&&e.trim().length>0?`Lyricistant - ${e}`:"Lyricistant";var pe=i(5303);const ye=(()=>{const e=new pe.hL;return e.registerSingleton(void 0,{identifier:"WebRendererDelegate",implementation:L}),e.registerSingleton(void 0,{identifier:"WebLogger",implementation:D}),e.registerSingleton(void 0,{identifier:"WebPreferences",implementation:F}),e.registerSingleton(void 0,{identifier:"WebRecentFiles",implementation:b}),e.registerSingleton(void 0,{identifier:"WebAppData",implementation:E}),e.registerSingleton(void 0,{identifier:"WebFiles",implementation:T}),e.registerSingleton(void 0,{identifier:"DOMSystemThemeProvider",implementation:w}),e.registerSingleton(void 0,{identifier:"DOMBuffers",implementation:x}),e.registerSingleton(void 0,{identifier:"DOMTimes",implementation:G}),((e,t)=>{t.registerTransient(e.files,{identifier:"Files"}),t.registerTransient(e.logger,{identifier:"Logger"}),t.registerTransient(e.logger,{identifier:"PlatformLogger"}),t.registerTransient(e.preferences,{identifier:"Preferences"}),t.registerTransient(e.recentFiles,{identifier:"RecentFiles"}),t.registerTransient(e.systemThemeProvider,{identifier:"SystemThemeProvider"}),t.registerTransient(e.appData,{identifier:"AppData"}),t.registerTransient(e.buffers,{identifier:"Buffers"}),t.registerTransient(e.uiConfigProvider,{identifier:"UiConfigProvider"}),t.registerTransient(e.titleFormatter,{identifier:"TitleFormatter"}),t.registerTransient(e.rendererDelegate,{identifier:"RendererDelegate"}),t.registerTransient(e.times,{identifier:"Times"}),t.registerSingleton(void 0,{identifier:"FileManager",implementation:$}),t.registerSingleton(void 0,{identifier:"PreferenceManager",implementation:Z}),t.registerSingleton(void 0,{identifier:"UiConfigManager",implementation:q}),t.registerSingleton(void 0,{identifier:"UnsavedDataManager",implementation:N}),t.registerSingleton(void 0,{identifier:"LogManager",implementation:Q}),t.registerSingleton(void 0,{identifier:"FileHistoryManager",implementation:X}),t.registerSingleton(void 0,{identifier:"FirstLaunchManager",implementation:ee}),t.registerSingleton(void 0,{identifier:"Clock",implementation:ie}),t.registerSingleton(void 0,{identifier:"LyricistantFileHandler",implementation:ae}),t.registerSingleton(void 0,{identifier:"TextFileHandler",implementation:he}),t.registerSingleton(void 0,{identifier:"FileHistory",implementation:ue}),t.registerSingleton((()=>[t.get({identifier:"FileHistory"})]),{identifier:"FileDataExtensions"}),t.registerSingleton((()=>[t.get({identifier:"LyricistantFileHandler"}),t.get({identifier:"TextFileHandler"})]),{identifier:"FileHandlers"})})({rendererDelegate:()=>e.get({identifier:"WebRendererDelegate"}),logger:()=>e.get({identifier:"WebLogger"}),files:()=>e.get({identifier:"WebFiles"}),preferences:()=>e.get({identifier:"WebPreferences"}),titleFormatter:()=>me,buffers:()=>e.get({identifier:"DOMBuffers"}),appData:()=>e.get({identifier:"WebAppData"}),systemThemeProvider:()=>e.get({identifier:"DOMSystemThemeProvider"}),recentFiles:()=>e.get({identifier:"WebRecentFiles"}),uiConfigProvider:()=>ve,times:()=>e.get({identifier:"DOMTimes"})},e),e.registerSingleton(void 0,{identifier:"UnloadManager",implementation:H}),((e,...t)=>{e.registerSingleton((()=>[e.get({identifier:"FileManager"}),e.get({identifier:"PreferenceManager"}),e.get({identifier:"UiConfigManager"}),e.get({identifier:"UnsavedDataManager"}),e.get({identifier:"LogManager"}),e.get({identifier:"FileHistoryManager"}),e.get({identifier:"FirstLaunchManager"}),...t]),{identifier:"Managers"})})(e,e.get({identifier:"UnloadManager"})),e})();self.onerror=e=>{var t;(null!==(t=null==ye?void 0:ye.get({identifier:"Logger"}))&&void 0!==t?t:console).error("Web Platform crashed",e),e instanceof ErrorEvent?n.onError(e.error):n.onError(e)},self.onunhandledrejection=e=>{self.onerror(e.reason)};const _e=()=>ye.get({identifier:"RendererDelegate"});(0,r.Jj)({receive:(e,t)=>{_e().receive(e,t)},onRendererListenerSet:e=>{_e().onRendererListenerSet(e)},getLogger:()=>{const e=ye.get({identifier:"Logger"});return(0,r.sj)(e)},start:()=>{try{ye.get({identifier:"Managers"}).forEach((e=>e.register()))}catch(e){self.onerror(e)}}})}},s={};function o(e){var t=s[e];if(void 0!==t)return t.exports;var i=s[e]={exports:{}};return n[e](i,i.exports,o),i.exports}o.m=n,o.x=()=>{var e=o.O(void 0,[313],(()=>o(3847)));return o.O(e)},e=[],o.O=(t,i,r,n)=>{if(!i){var s=1/0;for(h=0;h<e.length;h++){for(var[i,r,n]=e[h],l=!0,a=0;a<i.length;a++)(!1&n||s>=n)&&Object.keys(o.O).every((e=>o.O[e](i[a])))?i.splice(a--,1):(l=!1,n<s&&(s=n));if(l){e.splice(h--,1);var d=r();void 0!==d&&(t=d)}}return t}n=n||0;for(var h=e.length;h>0&&e[h-1][2]>n;h--)e[h]=e[h-1];e[h]=[i,r,n]},o.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return o.d(t,{a:t}),t},i=Object.getPrototypeOf?e=>Object.getPrototypeOf(e):e=>e.__proto__,o.t=function(e,r){if(1&r&&(e=this(e)),8&r)return e;if("object"==typeof e&&e){if(4&r&&e.__esModule)return e;if(16&r&&"function"==typeof e.then)return e}var n=Object.create(null);o.r(n);var s={};t=t||[null,i({}),i([]),i(i)];for(var l=2&r&&e;"object"==typeof l&&!~t.indexOf(l);l=i(l))Object.getOwnPropertyNames(l).forEach((t=>s[t]=()=>e[t]));return s.default=()=>e,o.d(n,s),n},o.d=(e,t)=>{for(var i in t)o.o(t,i)&&!o.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:t[i]})},o.f={},o.e=e=>Promise.all(Object.keys(o.f).reduce(((t,i)=>(o.f[i](e,t),t)),[])),o.u=e=>e+".renderer.js",o.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),o.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),o.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},(()=>{var e;o.g.importScripts&&(e=o.g.location+"");var t=o.g.document;if(!e&&t&&(t.currentScript&&(e=t.currentScript.src),!e)){var i=t.getElementsByTagName("script");if(i.length)for(var r=i.length-1;r>-1&&!e;)e=i[r--].src}if(!e)throw new Error("Automatic publicPath is not supported in this browser");e=e.replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/"),o.p=e})(),(()=>{var e={745:1};o.f.i=(t,i)=>{e[t]||importScripts(o.p+o.u(t))};var t=self.webpackChunklyricistant=self.webpackChunklyricistant||[],i=t.push.bind(t);t.push=t=>{var[r,n,s]=t;for(var l in n)o.o(n,l)&&(o.m[l]=n[l]);for(s&&s(o);r.length;)e[r.pop()]=1;i(t)}})(),r=o.x,o.x=()=>o.e(313).then(r),o.x()})();
//# sourceMappingURL=745.renderer.js.map